#include "dida/detail/vertical_decomposition/intersect.hpp"

#include <catch2/catch_test_macros.hpp>

#include "dida/detail/vertical_decomposition/sweep_line_builder.hpp"

namespace dida::detail::vertical_decomposition
{

TEST_CASE("intersect")
{
  auto test = [](PolygonView2 a, PolygonView2 b, bool expected_result)
  {
    VerticalDecomposition a_decomposition =
        vertical_decomposition_with_sweep_line_builder(a, VerticalDecompositionType::exterior_decomposition);
    VerticalDecomposition b_decomposition =
        vertical_decomposition_with_sweep_line_builder(b, VerticalDecompositionType::exterior_decomposition);

    CHECK(intersect(a, a_decomposition, b, b_decomposition) == expected_result);
    CHECK(intersect(b, b_decomposition, a, a_decomposition) == expected_result);
  };

  SECTION("Horizontally disjoint")
  {
    Polygon2 a{{-4.10, 3.32}, {-1.28, 0.00}, {1.30, 2.88}, {-0.68, 2.20}, {-3.84, 4.98}, {-5.74, 4.08}};
    Polygon2 b{{7.76, 2.86}, {4.86, 4.90}, {2.82, 3.06}, {5.10, 1.40}};
    test(a, b, false);
  }

  SECTION("B leftmost inside A")
  {
    Polygon2 a{
        {-1.78, 2.30}, {0.68, 2.80},  {3.78, 1.08},  {2.24, 3.40},  {0.94, 4.04},  {2.60, 4.96},  {3.98, 6.86},
        {1.70, 5.52},  {-0.46, 5.28}, {-2.56, 5.82}, {-4.08, 7.52}, {-3.60, 4.74}, {-0.80, 3.98}, {-1.40, 3.54},
    };
    Polygon2 b{{-0.08, 3.72}, {1.54, 2.86}, {1.28, 3.56}};
    test(a, b, true);
  }

  SECTION("B leftmost on A lower boundary")
  {
    Polygon2 a{
        {-5, 1}, {-4, 1}, {-4, 3}, {2, 3}, {2, 1}, {3, 1}, {3, 6}, {1, 6}, {1, 5}, {-3, 5}, {-3, 7}, {-5, 7},
    };
    Polygon2 b{{-1, 3}, {0, 2}, {1, 2}};
    test(a, b, true);
  }

  SECTION("B leftmost on A upper boundary")
  {
    Polygon2 a{
        {-5, 1}, {-4, 1}, {-4, 3}, {2, 3}, {2, 1}, {3, 1}, {3, 6}, {1, 6}, {1, 5}, {-3, 5}, {-3, 7}, {-5, 7},
    };
    Polygon2 b{{-2, 5}, {0, 6}, {-1, 7}};
    test(a, b, true);
  }

  SECTION("B leftmost on side vertex 1")
  {
    Polygon2 a{{2, 3}, {8, 3}, {5, 4}, {6, 5}, {4, 6}, {7, 7}, {2, 7}};
    Polygon2 b{{6, 5}, {8, 4}, {7, 6}};
    test(a, b, true);
  }

  SECTION("B leftmost on side vertex 2")
  {
    Polygon2 a{{3, 1}, {3, 7}, {-2, 6}, {2, 5}, {-1, 4}, {2, 2}, {-3, 2}};
    Polygon2 b{{-1, 4}, {0, 2.5}, {1, 2.5}};
    test(a, b, true);
  }

  {
    Polygon2 a{
        {-2.40, 1.34}, {2.80, 0.30},  {5.90, 3.58}, {4.08, 6.84}, {0.62, 7.78}, {-2.56, 6.30}, {-4.84, 6.24},
        {-2.52, 5.28}, {-0.04, 6.16}, {2.42, 5.98}, {4.10, 4.64}, {4.10, 2.30}, {1.02, 1.34},
    };

    SECTION("B inside single A region, no intersection")
    {
      Polygon2 b{{-1.06, 3.46}, {0.42, 2.38}, {2.20, 2.86}, {2.80, 4.12}, {1.96, 5.06}, {0.78, 5.36}, {-0.40, 4.48}};
      test(a, b, false);
    }

    SECTION("Intersection when advancing A, A is lower")
    {
      Polygon2 b{{-0.58, 2.26}, {0.72, 0.94}, {2.34, 2.32}, {3.14, 4.00}, {1.02, 4.98}, {-1.08, 3.52}};
      test(a, b, true);
    }

    SECTION("Intersection when advancing A, A is upper")
    {
      Polygon2 b{{0.22, 2.74}, {2.06, 2.38}, {3.24, 4.62}, {2.70, 6.34}, {0.22, 5.88}, {-1.28, 4.06}};
      test(a, b, true);
    }

    SECTION("Intersection when advancing B, B is lower")
    {
      Polygon2 b{{0.76, 2.54}, {2.04, 1.02}, {2.66, 2.70}, {3.48, 4.00}, {1.18, 5.12}, {-1.42, 3.74}};
      test(a, b, true);
    }

    SECTION("Intersection when advancing B, B is upper")
    {
      Polygon2 b{{1.50, 4.92}, {3.24, 4.50}, {1.66, 6.30}, {0.44, 5.46}, {-0.94, 4.28}};
      test(a, b, true);
    }
  }

  SECTION("Branching in intersect_iteration_advance_reverse_node")
  {
    SECTION("p_opp_edge.is_valid() && q_opp_edge.is_valid(), turning around")
    {
      SECTION("P is lower, intersection after branch")
      {
        Polygon2 a{
            {-4.74, 2.64}, {-3.10, -0.34}, {5.92, 1.06}, {-2.38, 0.82},
            {-3.48, 2.70}, {-2.62, 4.00},  {1.68, 4.18}, {-3.24, 5.22},
        };
        Polygon2 b{
            {-7.56, 4.84}, {-3.46, 6.58}, {2.76, 5.72}, {3.82, 4.12}, {2.64, 2.60},
            {-1.60, 4.40}, {2.54, 1.90},  {4.60, 4.10}, {3.10, 6.22}, {-3.54, 7.42},
        };
        test(a, b, true);
      }

      SECTION("P is lower, no intersection after branch")
      {
        Polygon2 a{
            {-4.74, 2.64}, {-3.10, -0.34}, {5.92, 1.06}, {-2.38, 0.82},
            {-3.48, 2.70}, {-2.62, 4.00},  {1.68, 4.18}, {-3.24, 5.22},
        };
        Polygon2 b{
            {-7.56, 4.84}, {-3.46, 6.58}, {2.76, 5.72}, {3.82, 4.12}, {2.64, 2.60},
            {-1.60, 2.40}, {2.54, 1.90},  {4.60, 4.10}, {3.10, 6.22}, {-3.54, 7.42},
        };
        test(a, b, false);
      }

      SECTION("P is upper, intersection after branch")
      {
        Polygon2 a{
            {1.42, 1.42}, {-1.84, 0.04}, {-5.24, 2.78}, {-3.26, 6.20}, {-0.26, 6.96},
            {3.84, 6.36}, {-0.22, 7.90}, {-3.94, 6.72}, {-6.36, 3.02}, {-2.10, -1.00},
        };
        Polygon2 b{
            {-4.10, -1.52}, {-1.62, -2.24}, {1.62, -0.96}, {2.90, 1.18}, {1.96, 2.84},  {-1.20, 3.34},
            {-3.24, 0.74},  {-1.12, 2.60},  {1.66, 2.42},  {2.38, 1.22}, {1.16, -0.62}, {-1.62, -1.70},
        };
        test(a, b, true);
      }

      SECTION("P is upper, no intersection after branch")
      {
        Polygon2 a{
            {1.42, 1.42}, {-1.84, 0.04}, {-5.24, 2.78}, {-3.26, 6.20}, {-0.26, 6.96},
            {3.84, 6.36}, {-0.22, 7.90}, {-3.94, 6.72}, {-6.36, 3.02}, {-2.10, -1.00},
        };
        Polygon2 b{
            {-4.14, -1.52}, {-1.56, -2.26}, {1.66, -0.96}, {2.82, 1.24}, {1.98, 2.82},  {-1.16, 3.40},
            {-3.90, 2.64},  {-1.14, 2.58},  {1.60, 2.08},  {2.02, 1.36}, {1.12, -0.56}, {-1.64, -1.68},
        };
        test(a, b, false);
      }
    }

    SECTION("p_opp_edge.is_valid() && q_opp_edge.is_valid(), not turning around")
    {
      SECTION("P is lower, intersection after branch")
      {
        Polygon2 a{
            {-2.06, 0.32}, {1.06, -0.54}, {3.14, 0.28}, {3.90, 3.26}, {3.28, 5.66}, {-0.54, 6.78},
            {-4.56, 5.58}, {-0.58, 6.12}, {2.66, 5.18}, {3.12, 3.36}, {2.64, 0.80}, {1.12, 0.30},
        };
        Polygon2 b{{-1.44, 1.30}, {5.06, 1.66}, {-1.34, 2.54}, {0.46, 3.94}, {-2.84, 4.54}, {-3.56, 3.50}};
        test(a, b, true);
      }

      SECTION("P is lower, no intersection after branch")
      {
        Polygon2 a{
            {-2.06, 0.32}, {1.06, -0.54}, {3.14, 0.28}, {3.90, 3.26}, {3.28, 5.66}, {-0.54, 6.78},
            {-4.56, 5.58}, {-0.58, 6.12}, {2.66, 5.18}, {3.12, 3.36}, {2.64, 0.80}, {1.12, 0.30},
        };
        Polygon2 b{
            {-3.60, 3.48}, {-1.38, 1.28}, {2.30, 1.44},  {0.46, 1.80},  {-0.94, 2.30},
            {-1.54, 2.86}, {0.52, 3.90},  {-1.34, 4.98}, {-2.92, 4.90},
        };
        test(a, b, false);
      }

      SECTION("P is upper, intersection after branch")
      {
        Polygon2 a{
            {-1.90, 1.14}, {-3.98, 1.96}, {-3.98, 4.64}, {-1.78, 5.82}, {1.14, 5.78},
            {2.90, 4.60},  {1.38, 6.54},  {-2.00, 6.54}, {-4.50, 5.18}, {-4.68, 1.76},
        };
        Polygon2 b{
            {-3.96, 0.58}, {-2.56, -0.26}, {-0.34, -0.42}, {2.18, 2.86}, {1.72, 7.20},  {-0.62, 8.22},
            {-3.18, 7.14}, {-0.72, 7.62},  {1.12, 6.34},   {1.34, 3.02}, {-0.68, 0.36}, {-2.56, 0.32},
        };
        test(a, b, true);
      }

      SECTION("P is upper, no intersection after branch")
      {
        Polygon2 a{
            {-1.90, 1.14}, {-3.98, 1.96}, {-3.98, 4.64}, {-1.78, 5.82}, {1.14, 5.78},
            {2.90, 4.60},  {1.38, 6.54},  {-2.00, 6.54}, {-4.50, 5.18}, {-4.68, 1.76},
        };
        Polygon2 b{
            {-3.98, 0.28}, {-2.02, -0.70}, {1.72, -0.40}, {4.92, 0.92},   {6.54, 3.16}, {4.36, 6.12},
            {2.08, 8.24},  {-1.18, 8.04},  {-3.30, 6.90}, {-1.20, 7.52},  {1.76, 7.34}, {3.46, 5.72},
            {4.80, 3.12},  {4.20, 1.56},   {1.54, 0.36},  {-2.08, -0.28},
        };
        test(a, b, false);
      }
    }

    SECTION("Only p_opp_edge.is_valid()")
    {
      SECTION("P is lower, intersection after branch")
      {
        Polygon2 a{
            {0.98, 3.86},  {2.68, 5.36}, {5.38, 4.58}, {4.06, 2.34}, {5.62, 1.20}, {9.40, 2.18},
            {12.74, 1.80}, {9.42, 3.06}, {6.44, 2.06}, {4.70, 2.46}, {6.56, 4.64}, {2.56, 6.34},
        };
        Polygon2 b{
            {3.56, 6.72},  {6.38, 6.44},  {8.44, 4.46}, {10.28, 3.80},
            {11.72, 1.24}, {10.68, 4.12}, {8.56, 5.16}, {6.58, 7.28},
        };
        test(a, b, true);
      }

      SECTION("P is lower, no intersection after branch")
      {
        Polygon2 a{
            {0.98, 3.86},  {2.68, 5.36}, {5.38, 4.58}, {4.06, 2.34}, {5.62, 1.20}, {9.40, 2.18},
            {12.74, 1.80}, {9.42, 3.06}, {6.44, 2.06}, {4.70, 2.46}, {6.56, 4.64}, {2.56, 6.34},
        };
        Polygon2 b{
            {3.46, 6.46},  {6.32, 6.26},  {8.38, 4.14}, {10.36, 3.60},
            {11.84, 4.96}, {10.30, 4.30}, {8.48, 4.80}, {6.40, 7.02},
        };
        test(a, b, false);
      }

      SECTION("P is upper, intersection after branch")
      {
        Polygon2 a{
            {-2.48, 3.22}, {-1.02, 2.20}, {2.34, 3.06}, {2.82, 3.70}, {2.32, 4.54},  {0.48, 4.62}, {-0.62, 5.32},
            {0.26, 6.26},  {2.26, 6.56},  {4.76, 5.90}, {8.12, 6.98}, {4.92, 6.50},  {2.32, 7.42}, {-0.30, 6.84},
            {-1.18, 5.48}, {0.24, 4.12},  {2.10, 4.00}, {2.08, 3.56}, {-0.92, 2.82},
        };
        Polygon2 b{
            {0.88, 1.60}, {3.58, 1.50}, {5.84, 2.60}, {6.94, 5.12},
            {7.96, 8.00}, {5.96, 5.26}, {5.64, 3.00}, {3.44, 2.56},
        };
        test(a, b, true);
      }

      SECTION("P is upper, no intersection after branch")
      {
        Polygon2 a{
            {-2.48, 3.22}, {-1.02, 2.20}, {2.34, 3.06}, {2.82, 3.70}, {2.32, 4.54},  {0.48, 4.62}, {-0.62, 5.32},
            {0.26, 6.26},  {2.26, 6.56},  {4.76, 5.90}, {8.12, 6.98}, {4.92, 6.50},  {2.32, 7.42}, {-0.30, 6.84},
            {-1.18, 5.48}, {0.24, 4.12},  {2.10, 4.00}, {2.08, 3.56}, {-0.92, 2.82},
        };
        Polygon2 b{{0.86, 1.62}, {3.56, 1.44}, {5.92, 2.62}, {6.90, 5.14}, {5.30, 3.28}, {3.44, 2.00}};
        test(a, b, false);
      }
    }

    SECTION("Only q_opp_edge.is_valid()")
    {
      SECTION("P is lower, intersection after branch")
      {
        Polygon2 a{
            {1.02, 3.76},  {2.92, 2.06}, {5.66, 2.92}, {8.08, 1.84},
            {10.06, 3.40}, {8.02, 2.84}, {5.48, 4.12}, {3.10, 2.98},
        };
        Polygon2 b{
            {6.26, 4.50}, {9.26, 5.00}, {11.48, 3.62}, {9.70, 0.72},  {8.08, 1.04},
            {7.36, 2.44}, {7.66, 0.42}, {10.02, 0.14}, {12.22, 3.64}, {9.26, 5.80},
        };
        test(a, b, true);
      }

      SECTION("P is lower, no intersection after branch")
      {
        Polygon2 a{
            {1.02, 3.76},  {2.92, 2.06}, {5.66, 2.92}, {8.08, 1.84},
            {10.06, 3.40}, {8.02, 2.84}, {5.48, 4.12}, {3.10, 2.98},
        };
        Polygon2 b{
            {5.70, 4.92}, {7.38, 5.26},   {10.64, 4.44}, {11.14, 2.92}, {9.40, 0.54},
            {8.14, 0.24}, {10.66, -0.40}, {12.32, 2.60}, {11.58, 4.86}, {7.34, 6.24},
        };
        test(a, b, false);
      }

      SECTION("P is upper, intersection after branch")
      {
        Polygon2 a{
            {1.02, 3.76},  {2.92, 2.06}, {5.66, 2.92}, {8.08, 1.84},
            {10.06, 3.40}, {8.02, 2.84}, {5.48, 4.12}, {3.10, 2.98},
        };
        Polygon2 b{
            {5.74, 0.76},  {12.22, -0.20}, {11.58, 5.84}, {7.06, 3.06}, {9.24, 3.82},
            {10.70, 3.96}, {11.38, 2.46},  {10.50, 0.72}, {8.68, 1.10}, {6.94, 1.42},
        };
        test(a, b, true);
      }

      SECTION("P is upper, no intersection after branch")
      {
        Polygon2 a{
            {1.02, 3.76},  {2.92, 2.06}, {5.66, 2.92}, {8.08, 1.84},
            {10.06, 3.40}, {8.02, 2.84}, {5.48, 4.12}, {3.10, 2.98},
        };
        Polygon2 b{
            {5.74, 0.76},  {12.22, -0.20}, {11.58, 5.84}, {7.06, 4.06}, {9.24, 3.82},
            {10.70, 3.96}, {11.38, 2.46},  {10.50, 0.72}, {8.68, 1.10}, {6.94, 1.42},
        };
        test(a, b, false);
      }
    }

    SECTION("Neither p_opp_edge nor q_opp_edge valid")
    {
      SECTION("P is lower")
      {
        Polygon2 a{{2.00, 3.54}, {3.92, 2.06}, {6.42, 2.04}, {8.44, 3.26}, {6.72, 4.38}, {4.18, 4.90}};
        Polygon2 b{{5.38, 6.06}, {7.04, 5.76}, {8.40, 4.54}, {9.80, 4.32}, {11.70, 5.32}, {10.04, 4.80}, {7.90, 6.60}};
        test(a, b, false);
      }

      SECTION("P is upper")
      {
        Polygon2 a{{2.00, 3.54}, {3.92, 2.06}, {6.42, 2.04}, {8.44, 3.26}, {6.72, 4.38}, {4.18, 4.90}};
        Polygon2 b{{5.26, 0.56}, {6.82, -0.74}, {10.14, -0.46}, {11.90, 1.80},
                   {9.78, 0.54}, {8.60, 1.70},  {7.84, 0.28}};
        test(a, b, false);
      }
    }
  }

  SECTION("Intersection in intersect_iteration_advance_reverse_node, with q.edge")
  {
    SECTION("Advancing A, A is lower")
    {
      Polygon2 a{{-4.48, 1.48}, {2.26, 2.26}, {0.50, 3.72}, {-3.20, 4.56}, {-0.88, 3.20}};
      Polygon2 b{{3.42, 1.72}, {2.74, 5.70}, {-3.68, 2.78}, {2.22, 5.08}, {2.94, 1.92}, {-4.10, 0.96}};
      test(a, b, true);
    }

    SECTION("Advancing A, A is upper")
    {
      Polygon2 a{{-5.52, 1.70}, {1.30, 2.82}, {-3.00, 4.66}, {-1.96, 3.24}};
      Polygon2 b{{-4.14, 0.54}, {3.62, 1.18}, {0.82, 1.62}, {2.60, 5.22}};
      test(a, b, true);
    }

    SECTION("Advancing B, B is lower")
    {
      Polygon2 a{{4.62, -0.90}, {4.98, 6.28}, {-4.02, 6.24}, {3.94, 5.00}, {3.40, 0.60}, {-4.76, 0.70}};
      Polygon2 b{{-3.58, 2.94}, {0.08, 2.06}, {-2.56, -1.28}, {1.08, 1.72}, {2.68, 2.36}, {-2.24, 3.68}};
      test(a, b, true);
    }

    SECTION("Advancing B, B is upper")
    {
      Polygon2 a{
          {-3.58, 0.26}, {4.80, -0.84}, {4.56, 6.92}, {-2.74, 6.34}, {-0.88, 5.62},
          {0.74, 5.96},  {3.24, 4.84},  {3.44, 0.18}, {1.02, 0.06},  {-1.24, 1.04},
      };
      Polygon2 b{{1.44, 3.22}, {0.60, 4.20}, {2.72, 5.82}, {-0.46, 5.04}, {-1.98, 3.92}};
      test(a, b, true);
    }
  }

  SECTION("Test intersect_iteration_advance_forward_node")
  {
    SECTION("P is lower")
    {
      Polygon2 a{
          {11.32, 8.44}, {6.66, 9.62},  {2.40, 8.72},  {0.66, 4.94}, {1.64, 1.16}, {5.48, 0.38},
          {10.68, 0.76}, {13.04, 3.00}, {10.46, 1.60}, {5.70, 1.26}, {2.74, 1.72}, {2.06, 3.10},
          {2.78, 4.66},  {4.80, 5.26},  {6.96, 4.54},  {9.18, 4.80}, {6.98, 5.42}, {5.08, 6.46},
          {2.76, 5.72},  {1.86, 4.76},  {2.82, 7.70},  {6.78, 9.00},
      };

      SECTION("p_vertex not visible from q.edge")
      {
        SECTION("Intersection after branch")
        {
          Polygon2 b{
              {4.66, -1.10}, {15.36, -1.14}, {16.30, 4.60}, {5.86, 3.52},  {6.66, 2.72},   {7.60, 1.20},
              {8.26, 2.28},  {10.66, 3.34},  {13.04, 3.58}, {13.78, 2.10}, {10.86, -0.16},
          };
          test(a, b, true);
        }

        SECTION("No intersection")
        {
          Polygon2 b{
              {8.84, -2.08}, {15.70, 2.14}, {15.50, 5.66}, {10.18, 4.50}, {7.90, 3.34},  {5.96, 3.42},
              {8.02, 2.68},  {10.26, 3.52}, {14.68, 4.74}, {14.96, 2.48}, {8.52, -1.12}, {2.68, -0.46},
          };
          test(a, b, false);
        }
      }

      SECTION("p_vertex visible from q.edge")
      {
        SECTION("Intersection after branch")
        {
          Polygon2 b{
              {3.06, -1.08}, {15.12, -1.46}, {15.46, 7.64}, {6.96, 7.88},  {3.48, 4.46},   {6.50, 6.48},
              {8.28, 6.60},  {10.00, 5.58},  {12.40, 5.82}, {14.20, 3.06}, {12.56, -0.58},
          };
          test(a, b, true);
        }

        SECTION("No intersection")
        {
          Polygon2 b{
              {2.30, -1.12}, {16.02, -1.88}, {15.20, 7.02}, {5.46, 7.92},  {6.60, 6.86},   {8.00, 6.74},
              {10.60, 5.46}, {12.14, 5.92},  {13.68, 5.54}, {14.60, 2.42}, {10.46, -0.60},
          };
          test(a, b, false);
        }
      }
    }

    SECTION("P is upper")
    {
      Polygon2 a{
          {1.08, 2.14}, {6.42, 0.48},  {13.40, 1.80}, {14.02, 9.94}, {6.92, 10.72}, {1.98, 9.48}, {5.64, 9.36},
          {8.76, 9.20}, {10.68, 7.32}, {11.52, 5.70}, {10.20, 4.38}, {7.70, 4.20},  {5.96, 5.28}, {3.58, 4.64},
          {5.60, 4.56}, {7.48, 3.26},  {10.18, 3.70}, {12.00, 4.00}, {10.08, 1.58}, {6.52, 1.24},
      };

      SECTION("p_vertex not visible from q.edge")
      {
        SECTION("Intersection after branch")
        {
          Polygon2 b{{-0.72, 2.48}, {2.24, 3.48}, {5.00, 2.76}, {8.00, 1.06}, {5.12, 3.48}, {2.10, 4.42}};
          test(a, b, true);
        }

        SECTION("No intersection")
        {
          Polygon2 b{
              {-0.38, 4.10}, {2.38, 2.40}, {3.66, 2.62}, {4.64, 3.40}, {6.10, 3.78},
              {4.10, 3.68},  {2.96, 3.02}, {1.28, 4.24}, {0.28, 4.64},
          };
          test(a, b, false);
        }
      }

      SECTION("p_vertex visible from q.edge")
      {
        SECTION("Intersection after branch")
        {
          Polygon2 b{
              {-2.44, 3.08}, {-0.62, 4.48}, {1.72, 4.50}, {3.84, 6.24},  {5.88, 5.04},
              {7.38, 5.88},  {3.64, 7.60},  {1.86, 5.82}, {-0.86, 5.56},
          };
          test(a, b, true);
        }

        SECTION("No intersection")
        {
          Polygon2 b{
              {-1.04, 3.38}, {0.32, 3.66}, {1.84, 3.64}, {3.68, 5.58},  {6.78, 7.52},
              {5.38, 8.08},  {2.36, 7.00}, {0.94, 4.92}, {-0.42, 4.82},
          };
          test(a, b, false);
        }
      }
    }

    SECTION("Leaf node")
    {
      SECTION("Towards right")
      {
        Polygon2 a{
            {-6.44, -0.68}, {-3.58, -1.60}, {1.78, -1.12}, {4.64, 0.46}, {6.16, 3.74}, {3.98, 6.46},  {-0.48, 7.98},
            {-3.54, 6.86},  {-0.30, 6.76},  {2.96, 5.46},  {4.34, 3.44}, {3.46, 1.36}, {1.68, -0.12}, {-3.50, -0.24},
        };
        Polygon2 b{{-2.60, 3.50}, {-0.52, 1.94}, {2.38, 1.80}, {4.76, 2.66}, {2.28, 2.38}, {-0.38, 2.64}};
        test(a, b, true);
      }

      SECTION("Towards left")
      {
        Polygon2 a{
            {-4.42, 0.22}, {-1.70, -1.06}, {3.50, 0.06}, {4.40, 2.96}, {3.32, 6.68}, {0.18, 8.48}, {-3.94, 8.22},
            {-7.06, 6.42}, {-3.94, 7.60},  {0.14, 7.64}, {2.54, 6.20}, {3.50, 2.98}, {2.94, 0.74}, {-1.48, -0.52},
        };
        Polygon2 b{
            {-5.50, 4.80},  {-3.74, 5.98}, {0.24, 6.28},   {2.12, 3.16}, {0.96, 1.36}, {-1.16, 0.28}, {-3.12, 0.76},
            {-1.88, -0.10}, {1.58, -1.50}, {-0.82, -0.04}, {1.30, 0.94}, {2.68, 3.24}, {0.16, 6.94},  {-4.00, 6.52},
        };
        test(a, b, true);
      }
    }
  }

  SECTION("Intersection in intersect_iteration_advance_reverse_node, with q.opp_edge")
  {
    SECTION("Advancing A, A is lower")
    {
      Polygon2 a{
          {-2.84, -2.78}, {0.76, -0.30}, {3.52, 2.84}, {3.78, 6.56},   {2.06, 8.60}, {-0.42, 9.08},
          {-3.24, 7.24},  {-0.44, 8.26}, {1.66, 7.62}, {2.66, 6.34},   {2.30, 3.02}, {0.72, 2.16},
          {-1.28, 2.02},  {0.16, 1.38},  {1.26, 1.48}, {-1.20, -0.30},
      };
      Polygon2 b{
          {-2.26, 3.60}, {-0.18, 1.08}, {-0.18, 1.40}, {-0.62, 1.84}, {-0.80, 2.22}, {-1.20, 2.66},
          {-1.34, 3.08}, {-1.68, 3.28}, {-1.96, 3.60}, {-1.20, 3.82}, {0.20, 3.78},  {-1.12, 4.34},
      };
      test(a, b, true);
    }

    SECTION("Advancing A, A is upper")
    {
      Polygon2 a{
          {-5.22, -0.22}, {-1.86, -1.16}, {3.76, -0.92}, {6.82, 3.28}, {4.18, 8.28},  {-1.34, 8.86},  {-6.18, 7.96},
          {-6.28, 5.34},  {-3.76, 4.06},  {-0.56, 3.86}, {2.22, 3.42}, {-0.50, 5.04}, {-3.42, 4.96},  {-5.20, 6.18},
          {-5.28, 7.20},  {-1.40, 8.14},  {3.58, 7.58},  {5.98, 3.40}, {3.14, -0.32}, {-1.60, -0.46},
      };
      Polygon2 b{
          {-2.28, 6.26}, {0.24, 5.80}, {0.44, 5.10},  {1.02, 4.64},  {1.42, 3.74},  {2.06, 2.98},
          {2.80, 2.52},  {3.18, 2.30}, {-0.26, 1.20}, {-2.68, 1.74}, {-4.76, 2.66}, {-3.10, 1.04},
          {-0.36, 0.72}, {3.90, 1.88}, {2.12, 6.62},  {-0.72, 7.72},
      };
      test(a, b, true);
    }

    SECTION("Advancing B, B is lower")
    {
      Polygon2 a{
          {3.72, 4.42}, {-5.04, 5.14}, {-6.38, 1.72},  {-5.62, -0.86}, {0.60, -0.60},
          {3.52, 0.82}, {0.14, 0.10},  {-4.70, -0.10}, {-5.64, 1.56},  {-4.80, 4.40},
      };
      Polygon2 b{{1.76, -0.32}, {0.42, -1.96}, {2.64, -0.24}, {-1.76, 1.84}, {-4.32, 1.34}};
      test(a, b, true);
    }

    SECTION("Advancing B, B is upper")
    {
      Polygon2 a{
          {-3.80, 4.26}, {-5.52, 1.30}, {-3.00, -0.32}, {-0.62, -0.40}, {2.98, 0.68},  {4.70, 3.60}, {3.96, 5.04},
          {2.00, 6.72},  {-1.18, 7.44}, {-4.26, 5.78},  {-1.20, 6.40},  {0.66, 6.08},  {3.58, 3.86}, {1.86, 1.76},
          {-0.76, 0.78}, {-2.92, 1.16}, {-4.52, 1.82},  {-3.08, 3.20},  {-0.88, 3.54},
      };
      Polygon2 b{{-3.58, 5.28}, {-2.14, 3.08}, {-2.68, 2.48}, {-1.34, 3.06}, {-2.50, 4.50}, {-3.04, 5.28}};
      test(a, b, true);
    }
  }

  SECTION("Separating")
  {
    SECTION("Intersection in second intersect_main_loop call")
    {
      Polygon2 a{
          {-4.06, 2.94}, {-3.46, 4.48},  {-0.02, 5.04}, {1.78, 4.28}, {0.40, 6.02},   {-2.66, 6.00}, {-4.96, 5.10},
          {-6.12, 2.00}, {-3.60, -0.68}, {2.70, -1.68}, {0.90, 0.18}, {-3.34, -0.22}, {-1.06, 2.00}, {-3.48, 1.54},
      };
      Polygon2 b{
          {-3.14, 3.16},  {-1.38, 3.20}, {-0.44, 2.52}, {-1.36, 0.72}, {-2.02, 0.54},
          {-2.28, -0.66}, {-1.56, 0.34}, {-0.56, 0.64}, {-0.24, 1.36}, {2.10, 1.40},
          {5.70, 1.94},   {3.90, 3.04},  {1.60, 2.40},  {-0.54, 4.02}, {-1.92, 3.92},
      };
      test(a, b, true);
    }

    SECTION("No intersection")
    {
      Polygon2 a{
          {-4.06, 2.94}, {-3.46, 4.48},  {-0.02, 5.04}, {1.78, 4.28}, {0.40, 6.02},   {-2.66, 6.00}, {-4.96, 5.10},
          {-6.12, 2.00}, {-3.60, -0.68}, {2.70, -1.68}, {0.90, 0.18}, {-3.34, -0.22}, {-1.06, 2.00}, {-3.48, 1.54},
      };
      Polygon2 b{
          {-2.48, 3.10}, {-0.34, 2.46}, {-1.56, 0.74}, {1.34, 1.24}, {3.98, -0.98}, {2.24, -2.84}, {-0.18, -2.04},
          {2.42, -3.84}, {6.32, -1.64}, {3.78, 2.38},  {6.88, 5.38}, {3.62, 6.22},  {1.52, 7.44},  {-2.18, 7.32},
          {1.62, 6.54},  {3.96, 4.00},  {2.08, 2.74},  {0.28, 4.30}, {0.66, 3.14},
      };
      test(a, b, false);
    }

    SECTION("No lower edge in initial region, no intersection")
    {
      Polygon2 a{
          {-6.20, 3.28}, {-4.12, 1.78}, {-2.74, 0.16}, {-2.32, 1.76}, {-3.90, 2.84}, {-1.40, 3.14},
          {1.60, 2.80},  {-0.40, 2.04}, {1.82, 0.12},  {4.02, 1.26},  {2.62, 2.70},  {4.82, 3.42},
          {1.92, 5.96},  {0.44, 5.40},  {1.42, 4.36},  {-0.74, 4.66}, {-0.90, 5.76}, {-0.26, 6.72},
          {-1.26, 7.70}, {-2.88, 6.76}, {-1.96, 5.40}, {-3.12, 4.12}, {-3.92, 5.16}, {-5.30, 4.70},
      };
      Polygon2 b{
          {-5.44, 0.32}, {-2.58, -2.12}, {-0.08, -2.16}, {3.58, -0.70},  {0.34, -1.14},  {-1.40, 1.76},
          {0.16, 2.70},  {-3.12, 2.76},  {-1.96, 1.80},  {-2.28, -1.02}, {-3.84, -0.52},
      };
      test(a, b, false);
    }

    SECTION("No lower edge in initial region, intersection")
    {
      Polygon2 a{
          {-6.96, 2.98}, {-3.66, 1.70}, {-4.12, 0.42}, {-0.96, 2.20}, {2.26, 0.14},  {5.02, 0.86},  {2.58, 2.50},
          {2.30, 5.52},  {-1.24, 6.36}, {0.86, 5.00},  {1.56, 3.72},  {-1.72, 3.58}, {-3.74, 4.96}, {-5.84, 4.72},
      };
      Polygon2 b{
          {3.28, -2.50}, {6.86, 0.10},  {6.00, 5.16}, {2.80, 8.80}, {-2.98, 7.96}, {-2.64, 4.82}, {0.88, 3.12},
          {-1.84, 5.02}, {-1.86, 7.74}, {2.40, 7.74}, {5.16, 4.68}, {5.90, 0.16},  {3.28, -1.52}, {-5.26, 0.14},
      };
      test(a, b, true);
    }

    SECTION("No upper edge in initial region, no intersection")
    {
      Polygon2 a{
          {1.60, 2.66},  {7.34, -0.78}, {13.58, 2.44}, {9.64, 3.64}, {7.74, 5.62}, {9.32, 7.84},
          {10.46, 6.24}, {11.58, 8.08}, {9.64, 9.54},  {6.30, 5.82}, {4.26, 8.86}, {2.46, 7.56},
          {3.10, 5.92},  {3.94, 7.02},  {5.36, 5.14},  {2.56, 4.42},
      };
      Polygon2 b{
          {3.34, 9.10},  {4.72, 10.20}, {6.28, 7.34},  {9.40, 10.22}, {12.44, 8.02},
          {10.62, 5.32}, {8.78, 5.54},  {11.58, 4.14}, {13.62, 7.68}, {9.56, 12.26},
          {6.86, 12.36}, {8.10, 10.40}, {5.64, 10.46}, {6.30, 12.00}, {4.22, 12.22},
      };
      test(a, b, false);
    }

    SECTION("No upper edge in initial region, intersection")
    {
      Polygon2 a{
          {-7.12, 2.22}, {5.12, 1.90},  {1.52, 4.46},  {-0.36, 5.30}, {0.62, 3.62},
          {2.28, 3.00},  {-2.94, 3.14}, {-1.60, 4.40}, {-3.88, 4.68}, {-3.62, 3.82},
          {-5.64, 3.66}, {-3.08, 7.00}, {2.16, 6.42},  {1.20, 7.74},  {-4.30, 8.24},
      };
      Polygon2 b{
          {-5.96, 7.50}, {-4.36, 8.90}, {1.92, 8.24}, {2.42, 5.76},   {-1.70, 6.08},
          {-3.58, 5.46}, {-1.10, 4.36}, {0.66, 4.30}, {-1.32, 5.06},  {-0.40, 5.72},
          {2.86, 5.58},  {4.92, 7.10},  {2.42, 9.02}, {-0.72, 10.12}, {-4.96, 9.94},
      };
      test(a, b, true);
    }
  }
}

} // namespace dida::detail::vertical_decomposition